<!DOCTYPE html>
<html>
<head>
    <title>Lista de Óculos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/oculos.css') }}">

    <script>
        function toggleForm() {
            const formDiv = document.getElementById('formOculos');
            formDiv.style.display = formDiv.style.display === 'none' ? 'block' : 'none';
        }

        function deletarOculos(id) {
            fetch('/oculos/delete/' + id, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Erro ao deletar o óculos.');
                    }
                })
                .catch(error => {
                    console.error('Erro na requisição:', error);
                    alert('Erro ao tentar deletar o óculos.');
                });
        }

        function preencherFormularioEdicao(id, nome, material, cor, tamanho, marca, genero, forma, valor, recebimento) {
            document.getElementById('editID').value = id;
            document.getElementById('editNome').value = nome;
            document.getElementById('editMaterial').value = material;
            document.getElementById('editCor').value = cor;
            document.getElementById('editTamanho').value = tamanho;
            document.getElementById('editMarca').value = marca;
            document.getElementById('editGenero').value = genero;
            document.getElementById('editForma').value = forma;
            document.getElementById('editValor').value = valor;
            document.getElementById('editRecebimento').value = recebimento;
            document.getElementById('formOculosEdit').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function atualizarOculos() {
            const id = document.getElementById('editID').value;
            const formData = new FormData();
            formData.append('Nome', document.getElementById('editNome').value);
            formData.append('ID_Material', document.getElementById('editMaterial').value);
            formData.append('Cor', document.getElementById('editCor').value);
            formData.append('Tamanho', document.getElementById('editTamanho').value);
            formData.append('ID_Marca', document.getElementById('editMarca').value);
            formData.append('Genero', document.getElementById('editGenero').value);
            formData.append('ID_Forma', document.getElementById('editForma').value);
            formData.append('Valor', document.getElementById('editValor').value);
            formData.append('Data_Recebimento', document.getElementById('editRecebimento').value);

            const imagem = document.getElementById('editImagem').files[0];
            if (imagem) {
                formData.append('Imagem', imagem);
            }

            fetch('/oculos/update/' + id, {
                method: 'PUT',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    alert('Óculos atualizado com sucesso!');
                    location.reload();
                } else {
                    alert('Erro ao atualizar o óculos.');
                }
            })
            .catch(error => {
                console.error('Erro ao enviar atualização:', error);
                alert('Erro ao enviar a atualização.');
            });
        }
    </script>
</head>
<body>
<div class="container table-wrapper">
    <h1 class="text-center">Óculos</h1>

    {% if error %}
        <div class="alert alert-warning text-center">{{ error }}</div>
    {% endif %}

    <!-- Botão para mostrar o formulário de criação -->
    <div class="text-center mb-3">
        <button class="btn btn-success" onclick="toggleForm()">+ Novo Óculos</button>
    </div>

    <!-- Formulário de criação (POST) -->
    <div id="formOculos" style="display: none;" class="mb-4">
        <form action="/oculos" method="POST" enctype="multipart/form-data" class="form-inline justify-content-center flex-wrap">
            <input type="text" name="Nome" class="form-control mx-1 mb-2" placeholder="Nome" required>

            <!-- ID_Material -->
            <select name="ID_Material" class="form-control mx-1 mb-2" required>
                <option value="">Selecione o Material</option>
                {% for material in materiais %}
                    <option value="{{ material['ID_Material'] }}">{{ material['Nome'] }}</option>
                {% endfor %}
            </select>

            <input type="text" name="Cor" class="form-control mx-1 mb-2" placeholder="Cor" required>
            <input type="text" name="Tamanho" class="form-control mx-1 mb-2" placeholder="Tamanho" required>

            <!-- ID_Marca -->
            <select name="ID_Marca" class="form-control mx-1 mb-2" required>
                <option value="">Selecione a Marca</option>
                {% for marca in marcas %}
                    <option value="{{ marca['ID_Marca'] }}">{{ marca['Nome'] }}</option>
                {% endfor %}
            </select>

            <input type="text" name="Genero" class="form-control mx-1 mb-2" placeholder="Gênero" required>

                        <!-- ID_Forma -->
            <select name="ID_Forma" class="form-control mx-1 mb-2" required>
                <option value="">Selecione a Forma</option>
                {% for forma in formas %}
                    <option value="{{ forma['ID_Forma'] }}">{{ forma['Nome'] }}</option>
                {% endfor %}
            </select>

            <input type="text" step="0.01" name="Valor" class="form-control mx-1 mb-2" placeholder="Valor" required>
            <input type="date" name="Data_Recebimento" class="form-control mx-1 mb-2" required>
            <input type="file" name="Imagem" accept="image/*" class="form-control-file mx-1 mb-2">
            <button type="submit" class="btn btn-primary mb-2">Salvar</button>
        </form>
    </div>

    <!-- Formulário de edição (PUT) -->
    <div id="formOculosEdit" style="display: none;" class="mb-4">
        <form onsubmit="event.preventDefault(); atualizarOculos();" class="form-inline justify-content-center flex-wrap">
            <input type="hidden" id="editID">
            <input type="text" id="editNome" class="form-control mx-1 mb-2" placeholder="Nome" required>

            <!-- ID_Material -->
            <select name="editMaterial" class="form-control mx-1 mb-2" required>
                <option value="">Selecione o Material</option>
                {% for material in materiais %}
                    <option value="{{ material['ID_Material'] }}">{{ material['Nome'] }}</option>
                {% endfor %}
            </select>

            <input type="text" id="editCor" class="form-control mx-1 mb-2" placeholder="Cor" required>
            <input type="text" id="editTamanho" class="form-control mx-1 mb-2" placeholder="Tamanho" required>

                 <!-- ID_Marca -->
            <select name="editMarca" class="form-control mx-1 mb-2" required>
                <option value="">Selecione a Marca</option>
                {% for marca in marcas %}
                    <option value="{{ marca['ID_Marca'] }}">{{ marca['Nome'] }}</option>
                {% endfor %}
            </select>

            <input type="text" id="editGenero" class="form-control mx-1 mb-2" placeholder="Gênero" required>

                        <!-- ID_Forma -->
            <select name="editForma" class="form-control mx-1 mb-2" required>
                <option value="">Selecione a Forma</option>
                {% for forma in formas %}
                    <option value="{{ forma['ID_Forma'] }}">{{ forma['Nome'] }}</option>
                {% endfor %}
            </select>

            <input type="text" step="0.01" id="editValor" class="form-control mx-1 mb-2" placeholder="Valor" required>
            <input type="date" id="editRecebimento" class="form-control mx-1 mb-2" required>
            <input type="file" id="editImagem" accept="image/*" class="form-control-file mx-1 mb-2">
            <button type="submit" class="btn btn-warning mb-2">Atualizar</button>
        </form>
    </div>

    <!-- Tabela -->
    {% if oculos %}
        <table class="table table-striped table-bordered text-center align-middle">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Material</th>
                    <th>Cor</th>
                    <th>Tamanho</th>
                    <th>Marca</th>
                    <th>Gênero</th>
                    <th>Forma</th>
                    <th>Valor</th>
                    <th>Data de Recebimento</th>
                    <th>Imagem</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for o in oculos %}
                <tr>
                    <td>{{ o['ID_Oculos'] }}</td>
                    <td>{{ o['Nome'] }}</td>
                    <td>
                      {% for m in materiais %}
                        {% if m['ID_Material'] == o['ID_Material'] %}
                          {{ m['Nome'] }}
                        {% endif %}
                      {% endfor %}
                    </td>
                    <td>{{ o['Cor'] }}</td>
                    <td>{{ o['Tamanho'] }}</td>
                    <td>
                        {% for marca in marcas %}
                         {% if marca['ID_Marca'] == o['ID_Marca'] %}
                             {{ marca['Nome'] }}
                          {% endif %}
                        {% endfor %}
                    </td>
                    <td>{{ o['Genero'] }}</td>
                    <td>
                      {% for forma in formas %}
                        {% if forma['ID_Forma'] == o['ID_Forma'] %}
                          {{ forma['Nome'] }}
                        {% endif %}
                      {% endfor %}
                    </td>
                    <td>R$ {{ o['Valor'] }}</td>
                    <td>{{ o['Data_Recebimento'] }}</td>
                    <td>
                        {% if o['Imagem'] %}
                            <img src="{{ url_for('static', filename='uploads/' + o['Imagem']) }}" width="80">
                        {% else %}
                            Sem imagem
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="preencherFormularioEdicao(
                            '{{ o['ID_Oculos'] }}',
                            '{{ o['Nome'] }}',
                            '{{ o['ID_Material'] }}',
                            '{{ o['Cor'] }}',
                            '{{ o['Tamanho'] }}',
                            '{{ o['ID_Marca'] }}',
                            '{{ o['Genero'] }}',
                            '{{ o['ID_Forma'] }}',
                            '{{ o['Valor'] }}',
                            '{{ o['Data_Recebimento'] }}'
                        )">Atualizar</button>
                        <button class="btn btn-sm btn-danger" onclick="deletarOculos('{{ o['ID_Oculos'] }}')">Deletar</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-center">Nenhum óculos disponível.</p>
    {% endif %}
</div>
</body>
</html>
